<!DOCTYPE html>
<html>
<head>
    <title>Database Connection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        pre {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Database Connection Test</h1>
    
    <div class="test-box">
        <h2>Configuration</h2>
        <p class="info">Supabase URL: https://yafswrgnzepfjtaeibep.supabase.co</p>
        <p class="info">Key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</p>
    </div>

    <div class="test-box">
        <h2>Tests</h2>
        <button onclick="testConnection()">1. Test Connection</button>
        <button onclick="testTables()">2. Check Tables</button>
        <button onclick="testUsers()">3. List Users</button>
        <button onclick="testAddPoints()">4. Test Add Points</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="test-box">
        <h2>Results</h2>
        <div id="results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yafswrgnzepfjtaeibep.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhZnN3cmduemVwZmp0YWVpYmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzk2NzIsImV4cCI6MjA3OTY1NTY3Mn0.p1cUTZBNMvWelU0Pkznd-U_mVGCxz5cihOdYtvVhpAo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            results.innerHTML += `<p class="${className}">${message}</p>`;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testConnection() {
            log('üîç Testing connection...', 'info');
            try {
                const { data, error } = await supabase.from('users').select('count');
                if (error) throw error;
                log('‚úÖ Connection successful!', 'success');
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
                log(`Details: ${JSON.stringify(error)}`, 'error');
            }
        }
        
        async function testTables() {
            log('üîç Checking tables...', 'info');
            const tables = ['users', 'balances', 'withdrawal_requests', 'game_plays'];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('count');
                    if (error) throw error;
                    log(`‚úÖ Table "${table}" exists`, 'success');
                } catch (error) {
                    log(`‚ùå Table "${table}" missing or error: ${error.message}`, 'error');
                }
            }
        }
        
        async function testUsers() {
            log('üîç Fetching users...', 'info');
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('user_id, username, points, vip_level')
                    .limit(10);
                
                if (error) throw error;
                
                if (data.length === 0) {
                    log('‚ö†Ô∏è No users found in database', 'error');
                    log('üí° Register a user first at http://localhost:3001/login', 'info');
                } else {
                    log(`‚úÖ Found ${data.length} users:`, 'success');
                    log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
                }
            } catch (error) {
                log(`‚ùå Error fetching users: ${error.message}`, 'error');
                log(`Details: ${JSON.stringify(error)}`, 'error');
            }
        }
        
        async function testAddPoints() {
            log('üîç Testing add points...', 'info');
            try {
                // First, get a user
                const { data: users, error: fetchError } = await supabase
                    .from('users')
                    .select('user_id, username, points')
                    .limit(1);
                
                if (fetchError) throw fetchError;
                
                if (users.length === 0) {
                    log('‚ö†Ô∏è No users to test with. Register a user first.', 'error');
                    return;
                }
                
                const user = users[0];
                log(`üìù Testing with user: ${user.username} (${user.user_id})`, 'info');
                log(`üìä Current points: ${user.points}`, 'info');
                
                // Try to add 100 points
                const newPoints = user.points + 100;
                const { data, error } = await supabase
                    .from('users')
                    .update({ points: newPoints })
                    .eq('user_id', user.user_id)
                    .select();
                
                if (error) throw error;
                
                log(`‚úÖ Successfully added 100 points!`, 'success');
                log(`üìä New points: ${newPoints}`, 'success');
                log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
                
            } catch (error) {
                log(`‚ùå Error adding points: ${error.message}`, 'error');
                log(`Details: ${JSON.stringify(error)}`, 'error');
            }
        }
        
        // Auto-run connection test on load
        window.onload = () => {
            log('üöÄ Database Test Tool Ready', 'info');
            log('Click buttons above to run tests', 'info');
            log('---', 'info');
        };
    </script>
</body>
</html>
